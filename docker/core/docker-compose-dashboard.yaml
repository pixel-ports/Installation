version: "3.5"
services:
  dashboard-kibana:
    restart: always
    container_name: dashboard-kibana
    image: kibana:7.2.0
    volumes:
      - ./kibana/config/:/usr/share/kibana/config:ro
    ports:
      - "5601:5601"
    #depends_on:
    #- elastalert
    logging:
      driver: "json-file"
      options:
        max-file: "5"
        max-size: "10m"
    networks:
      ih:
        ipv4_address: 172.24.1.23
  dashboard-api-db:
    restart: always
    container_name: mongo
    image: mongo
    ports:
      - "27017:27017"
    volumes:
      - dashboard-api-db:/data/db
    logging:
      driver: "json-file"
      options:
        max-file: "5"
        max-size: "10m"
    networks:
      dash-api-db:
        ipv4_address: 172.31.1.24

  dashboard-api:
    restart: always
    container_name: dashboard-api
    build: ./pixel-api/
    command: node index.js
    environment:
      NODE_ENV: production
      MONGO_URL: "mongodb://dashboard-api-db/pixel-db"
      IDM_URL: "https://id.pixel-ports.eu"
    depends_on:
      - dashboard-api-db
    ports:
      - "3060:3000"
    logging:
      driver: "json-file"
      options:
        max-file: "5"
        max-size: "10m"
    networks:
      dash-api-db:
        ipv4_address: 172.31.1.25
  dashboard:
    restart: always
    container_name: dashboard
    build: ./pixel_ports/
    depends_on:
      - dashboard-api
    ports:
      - "8080:8080"
    logging:
      driver: "json-file"
      options:
        max-file: "5"
        max-size: "10m"
  elastalert:
    image: "servercentral/elastalert"
    volumes:
      - ./praeco/config/elastalert.yaml:/opt/elastalert/config.yaml
      - ./praeco/config/api.config.json:/opt/elastalert-server/config/config.json
      - ./praeco/rules:/opt/elastalert/rules
      - ./praeco/rule_templates:/opt/elastalert/rule_templates
    extra_hosts:
      - "elasticsearch:172.24.1.11"
    logging:
      driver: "json-file"
      options:
        max-file: "5"
        max-size: "10m"
    network:
      ih:
        ipv4_address: 172.24.1.26
  webapp:
    image: "servercentral/praeco"
    ports:
      - "8085:8080"
    volumes:
      - ./praeco/public/praeco.config.json:/var/www/html/praeco.config.json
      - ./praeco/nginx_config/nginx.conf:/etc/nginx/nginx.conf
      - ./praeco/nginx_config/default.conf:/etc/nginx/conf.d/default.conf
    extra_hosts:
      - "elasticsearch:172.24.1.11"
      - "elastalert:172.24.1.26"
    logging:
      driver: "json-file"
      options:
        max-file: "5"
        max-size: "10m"
    network:
      ih:
        ipv4_address: 172.24.1.27
volumes:
  dashboard-api-db:
